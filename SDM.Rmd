---
title: "Bradypus"
author: "Brad Anderson"
date: "October 10, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE}
library(dismo)
library(tidyverse)
library(sf)
library(sp)
library(raster)
library(rgdal)
library(maptools)


```

#Set Data Locations
```{r PARAMETERS and FILE LOCATIONS, include=FALSE}

#Species Occurence Points
occurence <- read_csv("~/github/sdm/oakwoodland_points.csv")

#Climate Variables Folder
variable_path <- file.path("H:/SDM/Climate/CCMSM4_rcp85/2010-2039/")

#Soil
soils <- raster("H:/SDM/Soils/top_soils.tif")

#DEM
DEM <- raster("H:/SDM/DEM_usgs_2013/DEM_clip_ProjectRaster.tif")

#Aspect
aspect <- raster("H:/SDM/DEM_usgs_2013/aspect/Aspect.tif")

#Slope
slope <- raster("H:/SDM/DEM_usgs_2013/slope/slope.tif")

```

#Import species occurence points.
```{r plot points}

#Plot Points
data(wrld_simpl)
plot(wrld_simpl, xlim=c(-121,-120), ylim=c(34,35), axes=TRUE, col="light yellow")
points(points$Long, points$Lat, col='red', cex=0.75)


```

#Import environmental data:
"For any particular study the layers should all have the same spatial extent, resolution, origin, and projection. If necessary, use functions like crop, extend, aggregate, resample, and projectRaster from the raster package."

"A RasterStack can be formed from separate files and/or from a few layers (’bands’) from a single file. In fact, a RasterStack is a collection of RasterLayer objects with the same spatial extent and resolution. In essence it is a list of RasterLayer objects. A RasterStack can easily be formed form a collection of files in different locations and these can be mixed with RasterLayer objects that only exist in memory."

```{r RasterStack & Define Projection}
#Call all .tif files from the storage location
variables <- list.files(variable_path, pattern='tif$', full.names=TRUE )

#Stack climate tif files into a RasterStack
climate <- stack(variables)

#Define project (For some reason the BCM data comes unprojected)
crs(climate) <- CRS('+init=epsg:3310')



```

```{r Data Prep}

#Re-assign numbers
soils_reclass <- reclassify(soils,rcl=c(120,150,NA))
aspect_reclass <- reclassify(aspect,rcl=c(-Inf,0,NA))
slope_reclass <- reclassify(slope,rcl=c(-Inf,0,NA))

#Reproject to NAD83 CA Teale Albers
soils_proj <- projectRaster(soils_reclass, crs=crs(climate))
DEM_proj <- projectRaster(DEM, crs=crs(climate))
aspect_proj <- projectRaster(aspect_reclass, crs=crs(climate))
slope_proj <- projectRaster(slope_reclass, crs=crs(climate))


```

```{r}

#Crop
climate_crop <- crop(climate, soils_proj)
DEM_crop <- crop(DEM_proj, soils_proj)
aspect_crop <- crop(aspect_proj, soils_proj)
slope_crop <- crop(slope_proj, soils_proj)

climate_resample <- resample(climate_crop,DEM_crop,method='ngb',progress='text')
soils_resample <- resample(soils_proj,DEM_crop,method='ngb',progress='text')
aspect_resample <- resample(aspect_crop,DEM_crop,method='ngb',progress='text')
slope_resample <- resample(slope_crop,DEM_crop,method='ngb',progress='text')

predictors <- stack(climate_resample, soils_resample, DEM_crop, aspect_resample, slope_resample)

```

```{r eval=FALSE, include=FALSE}
jar <- paste(system.file(package="dismo"), "/java/maxent.jar", sep='')
xm <- maxent(predictors, points, factors='biome')
## Loading required namespace: rJava
plot(xm)
```

```{r eval=FALSE, include=FALSE}

e <- evaluate(pres_test, backg_test, xm, predictors)
e
px <- predict(predictors, xm, ext=ext, progress='')
par(mfrow=c(1,2))
plot(px, main='Maxent, raw values')
plot(wrld_simpl, add=TRUE, border='dark grey')
tr <- threshold(e, 'spec_sens')
plot(px > tr, main='presence/absence')
plot(wrld_simpl, add=TRUE, border='dark grey')
points(pres_train, pch='+')

```

```{r}
# only run if the maxent.jar file is available, in the right folder
jar <- paste(system.file(package="dismo"), "/java/maxent.jar", sep='')

# file with presence points
occurence <- paste("~/github/sdm/oakwoodland_points.csv")
occ <- read.table(occurence, header=TRUE, sep=',')[,-1]

# witholding a 20% sample for testing 
fold <- kfold(occ, k=5)
occtest <- occ[fold == 1, ]
occtrain <- occ[fold != 1, ]

# fit model, biome is a categorical variable
me <- maxent(predictors, occtrain, factors='biome')

# see the maxent results in a browser:
# me

# use "args"
# me2 <- maxent(predictors, occtrain, factors='biome', args=c("-J", "-P"))

# plot showing importance of each variable
plot(me)

# response curves
# response(me)

# predict to entire dataset
r <- predict(me, predictors) 

# with some options:
# r <- predict(me, predictors, args=c("outputformat=raw"), progress='text', 
#      filename='maxent_prediction.grd')

plot(r)
points(occ)

#testing
# background data
bg <- randomPoints(predictors, 1000)

#simplest way to use 'evaluate'
e1 <- evaluate(me, p=occtest, a=bg, x=predictors)

# alternative 1
# extract values
pvtest <- data.frame(extract(predictors, occtest))
avtest <- data.frame(extract(predictors, bg))

e2 <- evaluate(me, p=pvtest, a=avtest)

# alternative 2 
# predict to testing points 
testp <- predict(me, pvtest) 
head(testp)
testa <- predict(me, avtest) 

e3 <- evaluate(p=testp, a=testa)
e3
threshold(e3)

plot(e3, 'ROC')
```

```{r}
# only run if the maxent.jar file is available, in the right folder
jar <- paste(system.file(package="dismo"), "/java/maxent.jar", sep='')



# get predictor variables
fnames <- list.files(path=paste(system.file(package="dismo"), '/ex', sep=''), 
              pattern='grd', full.names=TRUE )
predictors <- stack(fnames)
#plot(predictors)

# file with presence points
occurence <- paste(system.file(package="dismo"), '/ex/bradypus.csv', sep='')
occ <- read.table(occurence, header=TRUE, sep=',')[,-1]

# witholding a 20% sample for testing 
fold <- kfold(occ, k=5)
occtest <- occ[fold == 1, ]
occtrain <- occ[fold != 1, ]

# fit model, biome is a categorical variable
me <- maxent(predictors, occtrain, factors='biome')

# see the maxent results in a browser:
# me

# use "args"
# me2 <- maxent(predictors, occtrain, factors='biome', args=c("-J", "-P"))

# plot showing importance of each variable
plot(me)

# response curves
# response(me)

# predict to entire dataset
r <- predict(me, predictors) 

# with some options:
# r <- predict(me, predictors, args=c("outputformat=raw"), progress='text', 
#      filename='maxent_prediction.grd')

plot(r)
points(occ)

#testing
# background data
bg <- randomPoints(predictors, 1000)

#simplest way to use 'evaluate'
e1 <- evaluate(me, p=occtest, a=bg, x=predictors)

# alternative 1
# extract values
pvtest <- data.frame(extract(predictors, occtest))
avtest <- data.frame(extract(predictors, bg))

e2 <- evaluate(me, p=pvtest, a=avtest)

# alternative 2 
# predict to testing points 
testp <- predict(me, pvtest) 
head(testp)
testa <- predict(me, avtest) 

e3 <- evaluate(p=testp, a=testa)
e3
threshold(e3)

plot(e3, 'ROC')
```

